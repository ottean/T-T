<!-- apps/desktop/template.html -->
<div class="desktop-container">
    <!-- === 第一层：横向滚动视窗 (Swiper) === -->
    <div class="desktop-swiper" ref="swiper" @scroll="handleScroll">
        
        <!-- === PAGE 1: 主页 === -->
        <div class="desktop-page">
            
            <!-- Hero Widget -->
            <div class="hero-widget"
                    :style="{ 
                    backgroundImage: heroSettings.bgImage ? 'url(' + heroSettings.bgImage + ')' : '', 
                    backgroundPosition: heroSettings.bgPosX + '% ' + heroSettings.bgPosY + '%',
                    backgroundSize: heroSettings.bgSize + '%',
                    color: heroSettings.textColor 
                    }"
                    @click="openEditor">
                    
                <div class="hero-overlay"></div>
                <!-- 左侧 -->
                <div class="hero-left">
                    <div class="clock-ring-container">
                        <svg class="clock-svg" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="47" fill="none" :stroke="heroSettings.textColor" stroke-opacity="0.2" stroke-width="3" />
                            <circle cx="50" cy="50" r="47" fill="none" :stroke="heroSettings.textColor" stroke-width="4" stroke-linecap="round" :stroke-dasharray="ringCircumference" :stroke-dashoffset="ringOffset" style="transition: stroke-dashoffset 1s linear;" />
                        </svg>
                        
                        <div class="avatar-mask">
                            <img v-if="userAvatar" 
                                    :src="userAvatar" 
                                    class="user-avatar" 
                                    :style="{ 
                                    transform: `translate(${(heroSettings.avatarPosX - 50)}%, ${(heroSettings.avatarPosY - 50)}%) scale(${heroSettings.avatarSize / 100})`
                                    }">
                            <div v-else class="avatar-empty-clickable"></div>
                        </div>
                    </div>
                    
                    <div class="battery-area">
                        <span>电量: {{ batteryLevel }}%</span>
                        <div class="battery-icon-shell" :style="{ borderColor: heroSettings.textColor }"><div class="battery-fill" :style="{ background: heroSettings.textColor, width: batteryLevel + '%' }"></div></div>
                    </div>
                </div>

                <!-- 右侧 -->
                <div class="hero-right">
                    <input v-model="headerText" class="header-input" :style="{ color: heroSettings.textColor }" @click.stop @change="saveData">
                    <div class="time-display"><div class="big-time">{{ timeString }}</div></div>
                    <div class="date-info">{{ dateString }} <span class="fancy-day">{{ dayString }}</span></div>
                    <div class="todo-list">
                        <div class="todo-item" v-for="(todo, index) in todos" :key="todo.id" :class="{ done: todo.done }">
                            <i class="heart-icon" :class="todo.done ? 'ri-heart-fill' : 'ri-heart-line'" @click.stop="toggleTodo(index)"></i>
                            <input v-model="todo.text" class="todo-input" :style="{ color: heroSettings.textColor }" placeholder="待办..." @click.stop @change="saveData">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Layout -->
            <div class="main-layout-area">
                
                <!-- Row 1: 顶部两个宽图标 (Message / Theater) -->
                <!-- 注意：点击这里会触发 openApp('messenger') -->
                <div v-if="sideApps[0]" class="app-item col-span-2" style="grid-row: 1;" @click="openApp(sideApps[0].id)">
                    <div class="app-icon"><i :class="sideApps[0].icon"></i></div>
                </div>
                <div v-if="sideApps[1]" class="app-item col-span-2" style="grid-row: 1;" @click="openApp(sideApps[1].id)">
                    <div class="app-icon"><i :class="sideApps[1].icon"></i></div>
                </div>

                <!-- Row 2-3: 照片墙 -->
                <div class="photo-grid-wrapper" style="grid-column: 1 / 5; grid-row: 2 / span 2;">
                    <div class="photo-widget" @click="openPhotoEditor">
                            <input type="file" id="photo-wall-upload" multiple accept="image/*" @change="handlePhotoUpload" style="display:none">
                            <template v-if="photoWall.length > 0">
                                <div class="photo-row"><div class="photo-track"><div class="scroll-group"><img v-for="p in photoWall" :key="'a-'+p.id" :src="p.url" class="photo-item" :style="{ width: p.width + 'px', objectPosition: 'center ' + p.y + '%' }"></div><div class="scroll-group"><img v-for="p in photoWall" :key="'b-'+p.id" :src="p.url" class="photo-item" :style="{ width: p.width + 'px', objectPosition: 'center ' + p.y + '%' }"></div></div></div>
                                <div class="photo-row bottom"><div class="photo-track"><div class="scroll-group"><img v-for="p in photoWall" :key="'ba-'+p.id" :src="p.url" class="photo-item" :style="{ width: p.width + 'px', objectPosition: 'center ' + p.y + '%' }"></div><div class="scroll-group"><img v-for="p in photoWall" :key="'bb-'+p.id" :src="p.url" class="photo-item" :style="{ width: p.width + 'px', objectPosition: 'center ' + p.y + '%' }"></div></div></div>
                            </template>
                            <div v-else class="photo-placeholder">
                                <i class="ri-image-add-line" style="font-size: 24px; color: var(--text-main);"></i>
                                <div style="font-size:10px; color:var(--text-main); opacity:0.6; margin-top:5px;">管理照片</div>
                            </div>
                    </div>
                    <input v-model="photoSettings.title" class="photo-title-outside" placeholder="TITLE" @click.stop @change="saveData">
                </div>

                <!-- Row 4-5: 底部混合布局 -->
                <div v-if="extraApps[0]" class="app-item" style="grid-column: 1; grid-row: 4;" @click="openApp(extraApps[0].id)">
                    <div class="app-icon"><i :class="extraApps[0].icon"></i></div>
                    <span class="app-name">{{ extraApps[0].name }}</span>
                </div>
                <div v-if="extraApps[1]" class="app-item" style="grid-column: 1; grid-row: 5;" @click="openApp(extraApps[1].id)">
                    <div class="app-icon"><i :class="extraApps[1].icon"></i></div>
                    <span class="app-name">{{ extraApps[1].name }}</span>
                </div>
                
                <!-- 倒数日组件 -->
                <div class="countdown-widget" 
                        style="grid-column: 2 / 5; grid-row: 4 / span 2;" 
                        :style="{ 
                        backgroundImage: countdown.bgImage ? 'url(' + countdown.bgImage + ')' : '',
                        backgroundPosition: countdown.bgPosX + '% ' + countdown.bgPosY + '%',
                        backgroundSize: countdown.bgSize + '%',
                        color: countdown.textColor
                        }"
                        @click="openCountdownEditor">
                    <div v-if="countdown.bgImage" style="position:absolute; inset:0; background:rgba(255,255,255,0.2); border-radius:24px; pointer-events:none;"></div>
                    <div class="countdown-left" style="position:relative; z-index:1;">
                        <span class="countdown-title" :style="{ color: countdown.textColor }">{{ countdown.title }}</span>
                        <span class="countdown-label" :style="{ color: countdown.textColor, borderColor: countdown.textColor }">{{ countdown.isFuture ? '还有' : '已经' }}</span>
                    </div>
                    <div class="countdown-right" style="position:relative; z-index:1;">
                        <span class="countdown-number" :style="{ color: countdown.textColor }">{{ countdown.days }}</span>
                        <span class="countdown-unit" :style="{ color: countdown.textColor }">Days</span>
                    </div>
                </div>

            </div>
        </div> <!-- End Page 1 -->

        <!-- === PAGE 2: 第二页 === -->
        <div class="desktop-page">
            <div class="main-layout-area" style="margin-top: 10px;">
                
                <!-- === 1. CP 恋爱组件 === -->
                <div class="cp-widget-container" style="grid-column: 1 / 3; grid-row: 1 / 3;">
                    <div class="love-card">
                        <input type="file" id="love-avatar-l" accept="image/*" @change="handleLoveAvatarL" style="display:none">
                        <input type="file" id="love-avatar-r" accept="image/*" @change="handleLoveAvatarR" style="display:none">
                        <input v-model="loveWidget.title" class="love-title" placeholder="恋爱日记" @change="saveData">
                        <input v-model="loveWidget.subtitle" class="love-subtitle" placeholder="颜文字/简介" @change="saveData">
                        <div class="love-avatars-row">
                            <div class="love-avatar-circle" @click="handleAvatarClick('L')">
                                <img v-if="loveWidget.avatarL" :src="loveWidget.avatarL" class="love-avatar-img">
                                <i v-else class="ri-add-line love-add-icon"></i>
                                <div v-if="loveWidget.avatarL && showDeleteL" class="btn-remove-avatar" @click.stop="deleteLoveAvatar('L')"><i class="ri-close-line"></i></div>
                            </div>
                            <div class="love-connector">
                                <i class="ri-heart-fill love-heart-dot"></i><i class="ri-heart-fill love-heart-dot" style="opacity:0.6; transform:scale(0.8);"></i><i class="ri-heart-fill love-heart-dot" style="opacity:0.3; transform:scale(0.6);"></i>
                            </div>
                            <div class="love-avatar-circle" @click="handleAvatarClick('R')">
                                <img v-if="loveWidget.avatarR" :src="loveWidget.avatarR" class="love-avatar-img">
                                <i v-else class="ri-add-line love-add-icon"></i>
                                <div v-if="loveWidget.avatarR && showDeleteR" class="btn-remove-avatar" @click.stop="deleteLoveAvatar('R')"><i class="ri-close-line"></i></div>
                            </div>
                        </div>
                        <input v-model="loveWidget.label" class="love-progress-label" placeholder="恋爱进度" @change="saveData">
                        <input v-model="loveWidget.days" class="love-progress-num" placeholder="0" @change="saveData">
                    </div>
                </div>

                <!-- === 2. 右侧 4 个 App === -->
                <div class="app-item" style="grid-column: 3; grid-row: 1;" @click="openApp(page2Apps[0].id)"><div class="app-icon"><i :class="page2Apps[0].icon"></i></div><span class="app-name">{{ page2Apps[0].name }}</span></div>
                <div class="app-item" style="grid-column: 4; grid-row: 1;" @click="openApp(page2Apps[1].id)"><div class="app-icon"><i :class="page2Apps[1].icon"></i></div><span class="app-name">{{ page2Apps[1].name }}</span></div>
                <div class="app-item" style="grid-column: 3; grid-row: 2;" @click="openApp(page2Apps[2].id)"><div class="app-icon"><i :class="page2Apps[2].icon"></i></div><span class="app-name">{{ page2Apps[2].name }}</span></div>
                <div class="app-item" style="grid-column: 4; grid-row: 2;" @click="openApp(page2Apps[3].id)"><div class="app-icon"><i :class="page2Apps[3].icon"></i></div><span class="app-name">{{ page2Apps[3].name }}</span></div>
                <div class="app-item" style="grid-column: 1; grid-row: 3;" @click="openApp(page2Apps[4].id)"><div class="app-icon"><i :class="page2Apps[4].icon"></i></div><span class="app-name">{{ page2Apps[4].name }}</span></div>

                <!-- === Row 4 左侧 App (占位) === -->
                <div class="app-item" style="grid-column: 1; grid-row: 4;">
                    <div class="app-icon" style="background:rgba(255,255,255,0.2); border:1px dashed #ccc;"><i class="ri-add-line" style="color:#ccc;"></i></div>
                    <span class="app-name" style="color:#ccc;">Add</span>
                </div>

                <!-- === 心情打卡大方块 === -->
                <div class="mood-grid-widget" :style="{ backgroundColor: moodCheck.selected !== null ? moodCheck.options[moodCheck.selected].color + '80' : 'rgba(255,255,255,0.45)', borderColor: moodCheck.selected !== null ? moodCheck.options[moodCheck.selected].color : 'rgba(255,255,255,0.6)' }">
                    <div class="mood-title-small" style="color: #555; cursor: pointer;" @click="resetMoodCheck">{{ moodCheck.selected !== null ? moodCheck.options[moodCheck.selected].text : 'MOOD LOG' }}</div>
                    <div class="mood-grid-inner">
                        <div class="mood-grid-item" v-for="(item, idx) in moodCheck.options" :key="idx" :class="{ active: moodCheck.selected === idx }" :style="{ backgroundColor: moodCheck.selected === idx ? item.color : 'rgba(255,255,255,0.3)', color: moodCheck.selected === idx ? '#fff' : '#666' }" @click="selectMoodCheck(idx)">{{ item.emoji }}</div>
                    </div>
                    <div v-if="moodCheck.lastTime" style="font-size:9px; text-align:right; color:#666; margin-top:5px; opacity:0.8;">Recorded at {{ moodCheck.lastTime }}</div>
                </div>

                <!-- === 抽签组件 === -->
                <div class="fortune-widget" :class="{ flipped: fortune.isFlipped }" @click="drawFortune">
                    <div class="fortune-inner">
                        <div class="fortune-front"><i class="ri-fire-line fortune-cover-icon"></i><span class="fortune-cover-text">今日运势</span></div>
                        <div class="fortune-back" v-if="fortune.current">
                            <div class="fortune-level">{{ fortune.current.level }}</div>
                            <div class="fortune-content">
                                <div class="fortune-item"><span class="fortune-label">宜</span><span class="fortune-text">{{ fortune.current.good }}</span></div>
                                <div style="width: 40%; height: 1px; background: rgba(0,0,0,0.1);"></div>
                                <div class="fortune-item"><span class="fortune-label">忌</span><span class="fortune-text">{{ fortune.current.bad }}</span></div>
                            </div>
                        </div>
                        <div class="fortune-back" v-else></div>
                    </div>
                </div>

                <!-- === 个人简介组件 === -->
                <div class="profile-widget" :style="{ backgroundImage: profile.bgImage ? 'url(' + profile.bgImage + ')' : '' }">
                    <div class="pf-avatar" @click="handleProfileImgClick('avatar')">
                        <img v-if="profile.avatar" :src="profile.avatar" style="border-radius:50%;"><i v-else class="ri-add-line"></i>
                        <div v-if="profile.avatar && showDeleteProfileAvatar" class="btn-remove-avatar" @click.stop="deleteProfileImg('avatar')"><i class="ri-close-line"></i></div>
                    </div>
                    <div class="pf-capsule-group">
                        <input v-model="profile.id" class="pf-capsule-id" placeholder="@ID" @change="saveData">
                        <input v-model="profile.sign" class="pf-capsule-sign" placeholder="请输入签名：" @change="saveData">
                    </div>
                    <input v-model="profile.sticker1" class="pf-sticker-top" @change="saveData">
                    <div class="pf-bio-box"><textarea v-model="profile.bio" placeholder="请输入内容：" @change="saveData"></textarea></div>
                    <div class="pf-info-box"><textarea v-model="profile.info" class="profile-textarea-small" placeholder="请输入内容：" @change="saveData"></textarea></div>
                    <input v-model="profile.sticker2" class="pf-sticker-bottom" @change="saveData">
                    <div class="pf-tags-box pf-info-style"><textarea v-model="profile.tag" class="profile-textarea-small" placeholder="请输入内容：" @change="saveData"></textarea></div>
                    <div class="pf-music-card">
                        <div class="pf-music-cover" @click="handleProfileImgClick('musicCover')">
                            <img v-if="profile.musicCover" :src="profile.musicCover"><i v-else class="ri-add-line"></i>
                            <div v-if="profile.musicCover && showDeleteMusicCover" class="btn-remove-avatar" @click.stop="deleteProfileImg('musicCover')"><i class="ri-close-line"></i></div>
                        </div>
                        <div class="pf-music-progress-row"><span class="music-time">00:52</span><div class="music-bar"><div class="music-bar-fill"></div></div><span class="music-time">03:18</span></div>
                        <div class="pf-music-ctrl-row"><i class="ri-star-line small-icon"></i><i class="ri-skip-back-fill"></i><i class="ri-pause-fill big-icon"></i><i class="ri-skip-forward-fill"></i><i class="ri-broadcast-line small-icon"></i></div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Pagination Dots -->
        <div class="pagination-dots">
            <span class="dot" :class="{ active: currentPage === 0 }" @click="scrollToPage(0)"></span>
            <span class="dot" :class="{ active: currentPage === 1 }" @click="scrollToPage(1)"></span>
        </div>

        <!-- Dock -->
        <div class="dock-container"><div class="app-item" v-for="app in dockApps" :key="app.id" @click="openApp(app.id)"><div class="app-icon dock-icon"><i :class="app.icon"></i></div></div></div>

        <!-- === Modals === -->
        <div v-if="showEditor" class="editor-modal-overlay" @click.self="closeEditor">
            <div class="editor-panel">
                <div class="editor-title">卡片个性化</div>
                <input type="file" id="hero-bg-upload" accept="image/*" @change="handleHeroBgUpload" style="display:none">
                <input type="file" id="avatar-upload" accept="image/*" @change="handleAvatarUpload" style="display:none">
                <div class="hero-actions-wrapper">
                    <div class="editor-row"><div v-if="!heroSettings.bgImage" class="btn-action full" @click="triggerHeroBgUpload">上传背景图</div><template v-else><div class="btn-action" @click="triggerHeroBgUpload">更换背景</div><div class="btn-delete" @click="deleteBg">删除背景</div></template></div>
                    <div class="editor-row"><div v-if="!userAvatar" class="btn-action full" @click="triggerAvatarUpload">上传头像</div><template v-else><div class="btn-action" @click="triggerAvatarUpload">更换头像</div><div class="btn-delete" @click="deleteAvatar">删除头像</div></template></div>
                </div>
                <div class="editor-controls-grid" style="margin-top:15px;">
                    <div class="editor-column" v-if="heroSettings.bgImage" :class="{ 'editor-section-full': !userAvatar }">
                        <div class="control-label" style="font-weight:bold;">背景调整</div>
                        <div class="control-group"><div class="control-label">缩放 ({{ heroSettings.bgSize }}%)</div><input type="range" v-model="heroSettings.bgSize" min="50" max="300" class="slider-input" @change="saveData"></div>
                        <div class="control-group"><div class="control-label">X轴 ({{ heroSettings.bgPosX }}%)</div><input type="range" v-model="heroSettings.bgPosX" min="0" max="100" class="slider-input" @change="saveData"></div>
                        <div class="control-group"><div class="control-label">Y轴 ({{ heroSettings.bgPosY }}%)</div><input type="range" v-model="heroSettings.bgPosY" min="0" max="100" class="slider-input" @change="saveData"></div>
                    </div>
                    <div class="editor-column" v-if="userAvatar" :class="{ 'editor-section-full': !heroSettings.bgImage }">
                        <div class="control-label" style="font-weight:bold;">头像调整</div>
                        <div class="control-group"><div class="control-label">缩放 ({{ heroSettings.avatarSize }}%)</div><input type="range" v-model="heroSettings.avatarSize" min="50" max="200" class="slider-input" @change="saveData"></div>
                        <div class="control-group"><div class="control-label">X轴 ({{ heroSettings.avatarPosX }}%)</div><input type="range" v-model="heroSettings.avatarPosX" min="0" max="100" class="slider-input" @change="saveData"></div>
                        <div class="control-group"><div class="control-label">Y轴 ({{ heroSettings.avatarPosY }}%)</div><input type="range" v-model="heroSettings.avatarPosY" min="0" max="100" class="slider-input" @change="saveData"></div>
                    </div>
                </div>
                <div class="control-group" style="margin-top:10px;"><div class="control-label">字体颜色</div><div class="color-picker-row"><input type="color" v-model="heroSettings.textColor" class="color-input"><span class="btn-reset" @click="resetTextColor">重置</span></div></div>
                <button class="btn-close" @click="closeEditor">完成 (Done)</button>
            </div>
        </div>

        <div v-if="countdown.showEditor" class="editor-modal-overlay" @click.self="closeCountdownEditor">
            <div class="editor-panel countdown-panel" :class="{ 'is-dragging': isDraggingSlider }">
                <div class="editor-title">纪念日设置</div>
                <div class="editor-controls-grid">
                    <div class="control-group"><div class="control-label">标题</div><input type="text" v-model="countdown.title" class="modal-input" placeholder="输入标题" @change="saveData"></div>
                    <div class="control-group"><div class="control-label">日期</div><input type="date" v-model="countdown.targetDate" class="modal-input" @change="saveData"></div>
                </div>
                <div class="hero-actions-wrapper" style="margin-top:15px;">
                    <div class="editor-row">
                        <div v-if="!countdown.bgImage" class="btn-action full" @click="triggerCountdownBgUpload">上传背景图<input type="file" id="countdown-bg-upload" accept="image/*" @change="handleCountdownBgUpload" style="display:none"></div>
                        <template v-else><div class="btn-action" @click="triggerCountdownBgUpload">更换图片<input type="file" id="countdown-bg-upload" accept="image/*" @change="handleCountdownBgUpload" style="display:none"></div><div class="btn-delete" @click="deleteCountdownBg">删除背景</div></template>
                    </div>
                </div>
                <div v-if="countdown.bgImage" class="editor-controls-grid" style="margin-top:10px;">
                    <div class="editor-section-full">
                        <div class="control-group"><div class="control-label">缩放 ({{ countdown.bgSize }}%)</div><input type="range" v-model="countdown.bgSize" min="50" max="300" class="slider-input" @change="saveData" @mousedown="onSliderStart" @mouseup="onSliderEnd" @touchstart="onSliderStart" @touchend="onSliderEnd"></div>
                        <div class="control-group"><div class="control-label">X轴 ({{ countdown.bgPosX }}%)</div><input type="range" v-model="countdown.bgPosX" min="0" max="100" class="slider-input" @change="saveData" @mousedown="onSliderStart" @mouseup="onSliderEnd" @touchstart="onSliderStart" @touchend="onSliderEnd"></div>
                        <div class="control-group"><div class="control-label">Y轴 ({{ countdown.bgPosY }}%)</div><input type="range" v-model="countdown.bgPosY" min="0" max="100" class="slider-input" @change="saveData" @mousedown="onSliderStart" @mouseup="onSliderEnd" @touchstart="onSliderStart" @touchend="onSliderEnd"></div>
                    </div>
                </div>
                <div class="control-group" style="margin-top:10px;">
                    <div class="control-label">文字颜色</div>
                    <div class="color-picker-row"><input type="color" v-model="countdown.textColor" class="color-input" @change="saveData"><span class="btn-reset" @click="countdown.textColor = '#ff9a8b'; saveData()">重置</span></div>
                </div>
                <button class="btn-close" @click="closeCountdownEditor" style="margin-top:15px;">完成 (Done)</button>
            </div>
        </div>

        <div v-if="showPhotoEditor" class="editor-modal-overlay" @click.self="closePhotoEditor">
            <div class="editor-panel">
                <div class="editor-title" style="display:flex; justify-content:space-between;"><span v-if="!photoSettings.currentEditId">照片墙管理</span><span v-else class="btn-back" @click="backToPhotoList"><i class="ri-arrow-left-line"></i> 返回</span><span class="btn-close" style="width:auto; margin:0; padding:5px 12px;" @click="closePhotoEditor">关闭</span></div>
                <div v-if="!photoSettings.currentEditId">
                    <div class="control-label">点击图片编辑细节</div>
                    <div class="photo-grid">
                        <div class="grid-item" v-for="(p, index) in photoWall" :key="'grid-'+p.id" @click="selectPhotoToEdit(p.id)"><img :src="p.url" class="grid-img" :style="{ objectPosition: 'center ' + p.y + '%' }"></div>
                        <div class="grid-item grid-add" @click="triggerPhotoUpload"><i class="ri-add-line" style="font-size:20px; color:#ccc;"></i></div>
                    </div>
                </div>
                <div v-else>
                    <div class="control-group"><div class="control-label">显示宽度 ({{ currentEditPhoto.width }}px)</div><input type="range" v-model="currentEditPhoto.width" min="40" max="150" class="slider-input" @change="saveData"></div>
                    <div class="control-group"><div class="control-label">图片垂直位置 ({{ currentEditPhoto.y }}%)</div><input type="range" v-model="currentEditPhoto.y" min="0" max="100" class="slider-input" @change="saveData"></div>
                    <div class="btn-delete" @click="deleteCurrentPhoto">删除这张照片</div>
                </div>
            </div>
        </div>
    </div>
</div>
