<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Phone</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="apps/desktop/desktop.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
    <div id="app-screen">
        <div id="vue-app">
            <div class="bg-orb orb-1"></div>
            <div class="bg-orb orb-2"></div>

            <div v-if="currentApp === 'desktop'" class="desktop-container">
                
                <!-- Hero Widget -->
                <div class="hero-widget"
                     :style="{ backgroundImage: heroSettings.bgImage ? 'url(' + heroSettings.bgImage + ')' : '', backgroundPosition: heroSettings.bgPosX + '% ' + heroSettings.bgPosY + '%', backgroundSize: heroSettings.bgSize + '%', color: heroSettings.textColor }"
                     @contextmenu.prevent="handleContextMenu" @touchstart="handleTouchStart" @touchend="handleTouchEnd" @click="triggerHeroBgUpload">
                    <div class="hero-overlay"></div>
                    <input type="file" id="hero-bg-upload" accept="image/*" @change="handleHeroBgUpload" style="display:none">
                    <div class="hero-left">
                        <div class="clock-ring-container" @click.stop="triggerAvatarUpload">
                            <svg class="clock-svg" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="47" fill="none" :stroke="heroSettings.textColor" stroke-opacity="0.2" stroke-width="3" />
                                <circle cx="50" cy="50" r="47" fill="none" :stroke="heroSettings.textColor" stroke-width="4" stroke-linecap="round" :stroke-dasharray="ringCircumference" :stroke-dashoffset="ringOffset" style="transition: stroke-dashoffset 1s linear;" />
                            </svg>
                            <img :src="userAvatar" class="user-avatar" :style="{ borderColor: heroSettings.textColor + '30', objectPosition: 'center ' + heroSettings.avatarPosY + '%' }">
                            <input type="file" id="avatar-upload" accept="image/*" @change="handleAvatarUpload" style="display:none">
                        </div>
                        <div class="battery-area">
                            <span>电量: {{ batteryLevel }}%</span>
                            <div class="battery-icon-shell" :style="{ borderColor: heroSettings.textColor }"><div class="battery-fill" :style="{ background: heroSettings.textColor, width: batteryLevel + '%' }"></div></div>
                        </div>
                    </div>
                    <div class="hero-right">
                        <input v-model="headerText" class="header-input" :style="{ color: heroSettings.textColor }" @click.stop>
                        <div class="time-display"><div class="big-time">{{ timeString }}</div></div>
                        <div class="date-info">{{ dateString }} <span class="fancy-day">{{ dayString }}</span></div>
                        <div class="todo-list">
                            <div class="todo-item" v-for="(todo, index) in todos" :key="todo.id" :class="{ done: todo.done }">
                                <i class="heart-icon" :class="todo.done ? 'fa-solid fa-heart' : 'fa-regular fa-heart'" @click.stop="toggleTodo(index)"></i>
                                <input v-model="todo.text" class="todo-input" :style="{ color: heroSettings.textColor }" placeholder="待办..." @click.stop>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 统一布局网格 -->
                <div class="main-layout-area">
                    <div class="app-item" @click="openApp('messenger')"><div class="app-icon"><i class="fa-solid fa-comment-dots"></i></div><span class="app-name">信使</span></div>

                    <!-- Photo Widget Wrapper (NEW) -->
                    <div class="photo-grid-wrapper">
                        <div class="photo-widget"
                             :style="{ backgroundImage: photoSettings.bgImage ? 'url(' + photoSettings.bgImage + ')' : '', backgroundPosition: photoSettings.bgPosX + '% ' + photoSettings.bgPosY + '%', backgroundSize: photoSettings.bgSize + '%' }"
                             @contextmenu.prevent="handlePhotoContextMenu" @touchstart="handlePhotoTouchStart" @touchend="handleTouchEnd"
                             @click="photoWall.length === 0 ? triggerPhotoUpload() : null">
                            
                            <input type="file" id="photo-wall-upload" multiple accept="image/*" @change="handlePhotoUpload" style="display:none">
                            
                            <template v-if="photoWall.length > 0">
                                <div class="photo-row">
                                    <div class="photo-track">
                                        <div class="scroll-group"><img v-for="p in photoWall" :key="'a-'+p.id" :src="p.url" class="photo-item" :style="{ width: p.width + 'px', objectPosition: 'center ' + p.y + '%' }"></div>
                                        <div class="scroll-group"><img v-for="p in photoWall" :key="'b-'+p.id" :src="p.url" class="photo-item" :style="{ width: p.width + 'px', objectPosition: 'center ' + p.y + '%' }"></div>
                                    </div>
                                </div>
                                <div class="photo-row bottom">
                                    <div class="photo-track">
                                        <div class="scroll-group"><img v-for="p in photoWall" :key="'ba-'+p.id" :src="p.url" class="photo-item" :style="{ width: p.width + 'px', objectPosition: 'center ' + p.y + '%' }"></div>
                                        <div class="scroll-group"><img v-for="p in photoWall" :key="'bb-'+p.id" :src="p.url" class="photo-item" :style="{ width: p.width + 'px', objectPosition: 'center ' + p.y + '%' }"></div>
                                    </div>
                                </div>
                            </template>
                            <div v-else class="photo-placeholder"><i class="fa-solid fa-images" style="font-size: 24px; margin-bottom: 5px;"></i><div>上传照片</div></div>
                        </div>
                        
                        <!-- 这里的标题现在在组件外面 -->
                        <input v-model="photoSettings.title" class="photo-title-outside" placeholder="TITLE" @click.stop>
                    </div>

                    <div class="app-item" @click="openApp('gallery')"><div class="app-icon"><i class="fa-solid fa-image"></i></div><span class="app-name">相册</span></div>
                    <div class="app-item" v-for="app in extraApps" :key="app.id" @click="openApp(app.id)"><div class="app-icon"><i :class="app.icon"></i></div><span class="app-name">{{ app.name }}</span></div>
                </div>

                <div class="dock-container"><div class="app-item" v-for="app in dockApps" :key="app.id" @click="openApp(app.id)"><div class="app-icon dock-icon"><i :class="app.icon"></i></div></div></div>

                <!-- Editors (Hero & Photo) - No Changes in HTML structure, CSS handles them -->
                <div v-if="showEditor" class="editor-modal-overlay" @click.self="closeEditor">
                    <div class="editor-panel">
                        <div class="editor-title">卡片个性化</div>
                        <div class="delete-actions"><div v-if="heroSettings.bgImage" class="btn-delete" @click="deleteBg">删除背景图</div><div v-if="userAvatar !== defaultAvatar" class="btn-delete" @click="deleteAvatar">重置头像</div></div>
                        <div class="control-group" v-if="heroSettings.bgImage"><div class="control-label">背景缩放 ({{ heroSettings.bgSize }}%)</div><input type="range" v-model="heroSettings.bgSize" min="50" max="300" class="slider-input"></div>
                        <div class="control-group" v-if="heroSettings.bgImage"><div class="control-label">背景水平 ({{ heroSettings.bgPosX }}%)</div><input type="range" v-model="heroSettings.bgPosX" min="0" max="100" class="slider-input"></div>
                        <div class="control-group" v-if="heroSettings.bgImage"><div class="control-label">背景垂直 ({{ heroSettings.bgPosY }}%)</div><input type="range" v-model="heroSettings.bgPosY" min="0" max="100" class="slider-input"></div>
                        <div class="control-group"><div class="control-label">头像垂直</div><input type="range" v-model="heroSettings.avatarPosY" min="0" max="100" class="slider-input"></div>
                        <div class="control-group"><div class="control-label">字体颜色</div><div class="color-picker-row"><input type="color" v-model="heroSettings.textColor" class="color-input"><span class="btn-reset" @click="resetTextColor">重置</span></div></div>
                        <button class="btn-close" @click="closeEditor">完成</button>
                    </div>
                </div>

                <div v-if="showPhotoEditor" class="editor-modal-overlay" @click.self="closePhotoEditor">
                    <div class="editor-panel">
                        <div class="editor-title" style="display:flex; justify-content:space-between;">
                            <span v-if="!photoSettings.currentEditId">照片墙管理</span>
                            <span v-else class="btn-back" @click="backToPhotoList"><i class="fa-solid fa-arrow-left"></i> 返回</span>
                            <span class="btn-close" style="width:auto; margin:0; padding:5px 12px;" @click="closePhotoEditor">关闭</span>
                        </div>
                        <div v-if="!photoSettings.currentEditId">
                            <div class="delete-actions">
                                <div class="btn-delete" style="border-color:#ccc; color:#333; background:#eee;" @click="triggerPhotoBgUpload">更换背景 <input type="file" id="photo-bg-upload" accept="image/*" @change="handlePhotoBgUpload" style="display:none"></div>
                                <div v-if="photoSettings.bgImage" class="btn-delete" @click="deletePhotoBg">删除背景</div>
                            </div>
                            <div class="control-group" v-if="photoSettings.bgImage"><div class="control-label">背景缩放 ({{ photoSettings.bgSize }}%)</div><input type="range" v-model="photoSettings.bgSize" min="50" max="300" class="slider-input"></div>
                            <div class="control-group" v-if="photoSettings.bgImage"><div class="control-label">背景水平 ({{ photoSettings.bgPosX }}%)</div><input type="range" v-model="photoSettings.bgPosX" min="0" max="100" class="slider-input"></div>
                            <div class="control-group" v-if="photoSettings.bgImage"><div class="control-label">背景垂直 ({{ photoSettings.bgPosY }}%)</div><input type="range" v-model="photoSettings.bgPosY" min="0" max="100" class="slider-input"></div>
                            <div class="control-label" style="margin-top:15px;">点击图片编辑细节</div>
                            <div class="photo-grid">
                                <div class="grid-item" v-for="(p, index) in photoWall" :key="'grid-'+p.id" @click="selectPhotoToEdit(p.id)"><img :src="p.url" class="grid-img" :style="{ objectPosition: 'center ' + p.y + '%' }"></div>
                                <div class="grid-item grid-add" @click="triggerPhotoUpload"><i class="fa-solid fa-plus" style="color:#ccc;"></i></div>
                            </div>
                        </div>
                        <div v-else>
                             <div class="control-group"><div class="control-label">显示宽度 ({{ currentEditPhoto.width }}px)</div><input type="range" v-model="currentEditPhoto.width" min="40" max="150" class="slider-input"></div>
                            <div class="control-group"><div class="control-label">图片垂直位置 ({{ currentEditPhoto.y }}%)</div><input type="range" v-model="currentEditPhoto.y" min="0" max="100" class="slider-input"></div>
                            <div class="btn-delete" @click="deleteCurrentPhoto">删除这张照片</div>
                        </div>
                    </div>
                </div>

            </div>
            <div v-if="currentApp === 'messenger'" style="padding:20px; text-align:center;"><h1>信使</h1><button @click="currentApp = 'desktop'">返回桌面</button></div>
        </div>
    </div>
    <script src="apps/desktop/desktop.js"></script>
    <script src="js/main.js"></script>
    <style>.bg-orb { position: absolute; border-radius: 50%; filter: blur(60px); z-index: 0; pointer-events: none; } .orb-1 { width: 200px; height: 200px; background: #ffecd2; top: -50px; left: -50px; opacity: 0.8; } .orb-2 { width: 300px; height: 300px; background: #fcb69f; bottom: -80px; right: -80px; opacity: 0.6; }</style>
</body>
</html>
